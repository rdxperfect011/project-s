{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto">
  <h2 class="text-3xl font-bold text-blue-700 mb-6">Manage Students</h2>

  <!-- Add Student Form -->
  <div class="glass rounded-3xl p-8 mb-8 border-2 border-white/10">
    <h3 class="text-2xl font-bold mb-6 text-white">Add New Student</h3>
    <form action="{{ url_for('admin_add_student') }}" method="post" class="space-y-6">
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-white mb-2">Full Name</label>
          <input name="name" required class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-white/60 backdrop-blur-sm focus:outline-none focus:border-white/40" placeholder="Student Name">
        </div>
        <div>
          <label class="block text-sm font-medium text-white mb-2">Roll No</label>
          <input name="roll_no" required class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-white/60 backdrop-blur-sm focus:outline-none focus:border-white/40" placeholder="e.g., 10A21">
        </div>
        <div>
          <label class="block text-sm font-medium text-white mb-2">Admission Number</label>
          <input name="admission_number" required class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-white/60 backdrop-blur-sm focus:outline-none focus:border-white/40" placeholder="e.g., ADM2024001">
        </div>
        <div>
          <label class="block text-sm font-medium text-white mb-2">Class</label>
          <select name="student_class" required class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white backdrop-blur-sm focus:outline-none focus:border-white/40">
            <option value="">Select Class</option>
            <option value="Nursery">Nursery</option>
            <option value="LKG">LKG</option>
            <option value="UKG">UKG</option>
            <option value="1st">1st Grade</option>
            <option value="2nd">2nd Grade</option>
            <option value="3rd">3rd Grade</option>
            <option value="4th">4th Grade</option>
            <option value="5th">5th Grade</option>
            <option value="6th">6th Grade</option>
            <option value="7th">7th Grade</option>
            <option value="8th">8th Grade</option>
            <option value="9th">9th Grade</option>
            <option value="10th">10th Grade</option>
            <option value="11th">11th Grade</option>
            <option value="12th">12th Grade</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-white mb-2">Section</label>
          <select name="section" required class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white backdrop-blur-sm focus:outline-none focus:border-white/40">
            <option value="">Select Section</option>
            <option value="A">Section A</option>
            <option value="B">Section B</option>
            <option value="C">Section C</option>
            <option value="D">Section D</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-white mb-2">Parent Name</label>
          <input name="parent_name" required class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-white/60 backdrop-blur-sm focus:outline-none focus:border-white/40" placeholder="Parent Name">
        </div>
        <div>
          <label class="block text-sm font-medium text-white mb-2">Parent Phone</label>
          <input name="parent_phone" required class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-white/60 backdrop-blur-sm focus:outline-none focus:border-white/40" placeholder="1234567890">
        </div>
        <div>
          <label class="block text-sm font-medium text-white mb-2">Admission Date</label>
          <input name="admission_date" type="date" required class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white backdrop-blur-sm focus:outline-none focus:border-white/40">
        </div>
      </div>
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-600 transition-all duration-300 transform hover:scale-105">
        <i class="fas fa-user-plus mr-2"></i>Add Student
      </button>
    </form>
  </div>

  <!-- Filter Section -->
  <div class="glass rounded-3xl p-6 mb-8 border-2 border-white/10">
    <div class="flex flex-wrap items-center gap-4">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-white mb-2">Filter by Class</label>
        <select id="classFilter" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white backdrop-blur-sm focus:outline-none focus:border-white/40">
          <option value="">All Classes</option>
          {% for class in classes %}
          <option value="{{ class }}" {% if selected_class == class %}selected{% endif %}>{{ class }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex gap-2">
        <button onclick="filterStudents()" class="bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-2 rounded-lg font-semibold hover:from-green-600 hover:to-teal-600 transition-all duration-300">
          <i class="fas fa-filter mr-2"></i>Filter
        </button>
        <a href="{{ url_for('admin_students') }}" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:from-gray-600 hover:to-gray-700 transition-all duration-300">
          <i class="fas fa-times mr-2"></i>Clear
        </a>
      </div>
    </div>
  </div>

  <!-- Student List by Class -->
  <div class="glass rounded-3xl p-8 border-2 border-white/10">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-white">Students by Class</h3>
      <div class="text-white/80">
        {% if selected_class %}
        <span class="bg-blue-500/20 px-3 py-1 rounded-full border border-blue-400/30">
          <i class="fas fa-filter mr-1"></i>{{ selected_class }}
        </span>
        {% endif %}
        <span class="ml-2 bg-purple-500/20 px-3 py-1 rounded-full border border-purple-400/30">
          {{ total_students }} Students
        </span>
      </div>
    </div>
    
    {% if students_by_class %}
      {% for class_name, students in students_by_class.items() %}
      <div class="mb-8">
        <div class="flex items-center mb-4">
          <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg font-bold">
            <i class="fas fa-users mr-2"></i>{{ class_name }}
          </div>
          <div class="ml-4 text-white/60">
            {{ students | length }} student{% if students | length != 1 %}s{% endif %}
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-white/20">
                <th class="text-left p-3 text-white font-semibold">Roll No</th>
                <th class="text-left p-3 text-white font-semibold">Admission No</th>
                <th class="text-left p-3 text-white font-semibold">Name</th>
                <th class="text-left p-3 text-white font-semibold">Class</th>
                <th class="text-left p-3 text-white font-semibold">Section</th>
                <th class="text-left p-3 text-white font-semibold">Parent</th>
                <th class="text-left p-3 text-white font-semibold">Phone</th>
                <th class="text-left p-3 text-white font-semibold">Admission Date</th>
                <th class="text-center p-3 text-white font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for student in students %}
              <tr class="border-b border-white/10 hover:bg-white/5 transition-colors duration-200">
                <td class="p-3 text-white/90">{{ student.roll_no }}</td>
                <td class="p-3 text-white/90">
                  <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded-full border border-green-400/30 text-sm font-mono">
                    {{ student.admission_number if student.admission_number else 'ADM' + student.id|string }}
                  </span>
                </td>
                <td class="p-3 text-white font-medium">{{ student.name }}</td>
                <td class="p-3 text-white/90">{{ student.student_class }}</td>
                <td class="p-3 text-white/90">
                  <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded-full border border-blue-400/30 text-sm">
                    Section {{ student.section }}
                  </span>
                </td>
                <td class="p-3 text-white/90">{{ student.parent_name }}</td>
                <td class="p-3 text-white/90">{{ student.parent_phone }}</td>
                <td class="p-3 text-white/90">{{ student.admission_date.strftime('%d-%m-%Y') if student.admission_date else 'N/A' }}</td>
                <td class="p-3 text-center">
                  <div class="flex justify-center gap-2">
                    <button onclick="showStudentDetails('{{ student.id }}')" class="bg-blue-500/20 text-blue-300 px-3 py-1 rounded-lg border border-blue-400/30 hover:bg-blue-500/30 transition-colors duration-200">
                      <i class="fas fa-eye"></i>
                    </button>
                    <form action="{{ url_for('admin_delete_student', student_id=student.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this student?');" class="inline">
                      <button type="submit" class="bg-red-500/20 text-red-300 px-3 py-1 rounded-lg border border-red-400/30 hover:bg-red-500/30 transition-colors duration-200">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    {% else %}
    <div class="text-center py-12">
      <i class="fas fa-users text-6xl text-white/30 mb-4"></i>
      <p class="text-white/60 text-lg">No students found{% if selected_class %} in {{ selected_class }}{% endif %}</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Student Details Modal -->
<div id="studentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="glass rounded-3xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto border-2 border-white/10">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-white">Student Details</h3>
      <button onclick="closeStudentDetails()" class="text-white/60 hover:text-white transition-colors">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>
    
    <div id="studentDetailsContent">
      <!-- Content will be loaded here -->
    </div>
  </div>
</div>

<script>
function filterStudents() {
  const selectedClass = document.getElementById('classFilter').value;
  const url = new URL(window.location);
  if (selectedClass) {
    url.searchParams.set('filter_class', selectedClass);
  } else {
    url.searchParams.delete('filter_class');
  }
  window.location.href = url.toString();
}

function showStudentDetails(studentId) {
  fetch(`/admin/student_details/${studentId}`)
    .then(response => response.json())
    .then(data => {
      const content = document.getElementById('studentDetailsContent');
      
      let feePaymentsHtml = '';
      if (data.fee_payments && data.fee_payments.length > 0) {
        feePaymentsHtml = `
          <div class="mt-6">
            <h4 class="text-xl font-bold text-white mb-4">Fee Payment History</h4>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-white/20">
                    <th class="text-left p-3 text-white font-semibold">Month</th>
                    <th class="text-left p-3 text-white font-semibold">Amount</th>
                    <th class="text-left p-3 text-white font-semibold">Status</th>
                    <th class="text-left p-3 text-white font-semibold">Date</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.fee_payments.map(payment => `
                    <tr class="border-b border-white/10">
                      <td class="p-3 text-white/90">${payment.payment_month}</td>
                      <td class="p-3 text-white/90">â‚¹${payment.amount}</td>
                      <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-sm ${payment.paid ? 'bg-green-500/20 text-green-300 border border-green-400/30' : 'bg-yellow-500/20 text-yellow-300 border border-yellow-400/30'}">
                          ${payment.paid ? 'Paid' : 'Pending'}
                        </span>
                      </td>
                      <td class="p-3 text-white/90">${payment.submitted_at}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      } else {
        feePaymentsHtml = `
          <div class="mt-6">
            <h4 class="text-xl font-bold text-white mb-4">Fee Payment History</h4>
            <div class="text-center py-8">
              <i class="fas fa-receipt text-4xl text-white/30 mb-3"></i>
              <p class="text-white/60">No fee payment records found</p>
            </div>
          </div>
        `;
      }
      
      content.innerHTML = `
        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div class="bg-white/5 rounded-lg p-4 border border-white/10">
              <h4 class="text-lg font-semibold text-white mb-3">Personal Information</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-white/60">Full Name:</span>
                  <span class="text-white font-medium">${data.name}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-white/60">Admission No:</span>
                  <span class="text-white font-medium">${data.admission_number}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-white/60">Roll No:</span>
                  <span class="text-white font-medium">${data.roll_no}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-white/60">Admission Date:</span>
                  <span class="text-white font-medium">${data.admission_date}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-4">
            <div class="bg-white/5 rounded-lg p-4 border border-white/10">
              <h4 class="text-lg font-semibold text-white mb-3">Academic Information</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-white/60">Class:</span>
                  <span class="text-white font-medium">${data.student_class}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-white/60">Section:</span>
                  <span class="text-white font-medium">${data.section}</span>
                </div>
              </div>
            </div>
            
            <div class="bg-white/5 rounded-lg p-4 border border-white/10">
              <h4 class="text-lg font-semibold text-white mb-3">Parent Information</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-white/60">Parent Name:</span>
                  <span class="text-white font-medium">${data.parent_name}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-white/60">Phone:</span>
                  <span class="text-white font-medium">${data.parent_phone}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        ${feePaymentsHtml}
      `;
      
      document.getElementById('studentDetailsModal').classList.remove('hidden');
    })
    .catch(error => {
      console.error('Error fetching student details:', error);
      alert('Error loading student details. Please try again.');
    });
}

function closeStudentDetails() {
  document.getElementById('studentDetailsModal').classList.add('hidden');
}
</script>
{% endblock %}