{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto">
  <h2 class="text-3xl font-bold text-blue-700 mb-6">Manage Visits</h2>

  <!-- Filter Section -->
  <div class="glass rounded-3xl p-6 mb-8 border-2 border-white/10">
    <div class="flex flex-wrap items-center gap-4">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-white mb-2">Filter by Status</label>
        <select id="statusFilter" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white backdrop-blur-sm focus:outline-none focus:border-white/40">
          <option value="">All Status</option>
          {% for status in statuses %}
          <option value="{{ status }}" {% if selected_status == status %}selected{% endif %}>{{ status.title() }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-white mb-2">Filter by Date</label>
        <input type="date" id="dateFilter" value="{{ selected_date }}" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white backdrop-blur-sm focus:outline-none focus:border-white/40">
      </div>
      <div class="flex gap-2">
        <button onclick="filterVisits()" class="bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-2 rounded-lg font-semibold hover:from-green-600 hover:to-teal-600 transition-all duration-300">
          <i class="fas fa-filter mr-2"></i>Filter
        </button>
        <a href="{{ url_for('admin_visits') }}" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:from-gray-600 hover:to-gray-700 transition-all duration-300">
          <i class="fas fa-times mr-2"></i>Clear
        </a>
      </div>
    </div>
  </div>

  <!-- Visits List -->
  <div class="glass rounded-3xl p-8 border-2 border-white/10">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-white">Scheduled Visits</h3>
      <div class="text-white/80">
        {% if selected_status %}
        <span class="bg-blue-500/20 px-3 py-1 rounded-full border border-blue-400/30">
          <i class="fas fa-filter mr-1"></i>{{ selected_status.title() }}
        </span>
        {% endif %}
        {% if selected_date %}
        <span class="bg-purple-500/20 px-3 py-1 rounded-full border border-purple-400/30">
          <i class="fas fa-calendar mr-1"></i>{{ selected_date }}
        </span>
        {% endif %}
        <span class="ml-2 bg-green-500/20 px-3 py-1 rounded-full border border-green-400/30">
          {{ visits | length }} Visit{% if visits | length != 1 %}s{% endif %}
        </span>
      </div>
    </div>
    
    {% if visits %}
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-white/20">
            <th class="text-left p-3 text-white font-semibold">Date</th>
            <th class="text-left p-3 text-white font-semibold">Time</th>
            <th class="text-left p-3 text-white font-semibold">Student Name</th>
            <th class="text-left p-3 text-white font-semibold">Class</th>
            <th class="text-left p-3 text-white font-semibold">Parent Name</th>
            <th class="text-left p-3 text-white font-semibold">Phone</th>
            <th class="text-left p-3 text-white font-semibold">Purpose</th>
            <th class="text-left p-3 text-white font-semibold">Status</th>
            <th class="text-center p-3 text-white font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for visit in visits %}
          <tr class="border-b border-white/10 hover:bg-white/5 transition-colors duration-200">
            <td class="p-3 text-white/90">{{ visit.visit_date.strftime('%d-%m-%Y') }}</td>
            <td class="p-3 text-white/90">{{ visit.visit_time }}</td>
            <td class="p-3 text-white font-medium">{{ visit.student_name }}</td>
            <td class="p-3 text-white/90">{{ visit.student_class }}</td>
            <td class="p-3 text-white/90">{{ visit.parent_name }}</td>
            <td class="p-3 text-white/90">{{ visit.parent_phone }}</td>
            <td class="p-3 text-white/90">
              <div class="max-w-xs truncate" title="{{ visit.purpose }}">
                {{ visit.purpose }}
              </div>
            </td>
            <td class="p-3">
              {% if visit.status == 'scheduled' %}
                <span class="bg-yellow-500/20 text-yellow-300 px-3 py-1 rounded-full border border-yellow-400/30">
                  <i class="fas fa-clock mr-1"></i>{{ visit.status.title() }}
                </span>
              {% elif visit.status == 'completed' %}
                <span class="bg-green-500/20 text-green-300 px-3 py-1 rounded-full border border-green-400/30">
                  <i class="fas fa-check mr-1"></i>{{ visit.status.title() }}
                </span>
              {% elif visit.status == 'cancelled' %}
                <span class="bg-red-500/20 text-red-300 px-3 py-1 rounded-full border border-red-400/30">
                  <i class="fas fa-times mr-1"></i>{{ visit.status.title() }}
                </span>
              {% endif %}
            </td>
            <td class="p-3 text-center">
              <div class="flex justify-center gap-2">
                <!-- Status Update Dropdown -->
                <form action="{{ url_for('admin_update_visit_status', visit_id=visit.id) }}" method="post" class="inline">
                  <select name="status" onchange="this.form.submit()" class="bg-white/10 border border-white/20 rounded px-2 py-1 text-white text-sm backdrop-blur-sm focus:outline-none focus:border-white/40">
                    <option value="scheduled" {% if visit.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                    <option value="completed" {% if visit.status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if visit.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                  </select>
                </form>
                
                <!-- Delete Button -->
                <form action="{{ url_for('admin_delete_visit', visit_id=visit.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this visit?');" class="inline">
                  <button type="submit" class="bg-red-500/20 text-red-300 px-3 py-1 rounded-lg border border-red-400/30 hover:bg-red-500/30 transition-colors duration-200">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-12">
      <i class="fas fa-calendar-alt text-6xl text-white/30 mb-4"></i>
      <p class="text-white/60 text-lg">No visits found</p>
      {% if selected_status or selected_date %}
        <p class="text-white/40 text-sm mt-2">Try adjusting your filters</p>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- Visit Statistics -->
  <div class="grid md:grid-cols-3 gap-6 mt-8">
    <div class="glass rounded-3xl p-6 border-2 border-white/10 text-center">
      <div class="text-3xl font-bold text-yellow-300 mb-2">
        {{ visits | selectattr('status', 'equalto', 'scheduled') | list | length }}
      </div>
      <div class="text-white/80">Scheduled</div>
    </div>
    <div class="glass rounded-3xl p-6 border-2 border-white/10 text-center">
      <div class="text-3xl font-bold text-green-300 mb-2">
        {{ visits | selectattr('status', 'equalto', 'completed') | list | length }}
      </div>
      <div class="text-white/80">Completed</div>
    </div>
    <div class="glass rounded-3xl p-6 border-2 border-white/10 text-center">
      <div class="text-3xl font-bold text-red-300 mb-2">
        {{ visits | selectattr('status', 'equalto', 'cancelled') | list | length }}
      </div>
      <div class="text-white/80">Cancelled</div>
    </div>
  </div>
</div>

<script>
function filterVisits() {
  const selectedStatus = document.getElementById('statusFilter').value;
  const selectedDate = document.getElementById('dateFilter').value;
  const url = new URL(window.location);
  
  if (selectedStatus) {
    url.searchParams.set('filter_status', selectedStatus);
  } else {
    url.searchParams.delete('filter_status');
  }
  
  if (selectedDate) {
    url.searchParams.set('filter_date', selectedDate);
  } else {
    url.searchParams.delete('filter_date');
  }
  
  window.location.href = url.toString();
}
</script>
{% endblock %}
